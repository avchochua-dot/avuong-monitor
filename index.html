<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>A V∆∞∆°ng ‚Ä¢ Reservoir Monitoring and Operation ‚Ä¢ AI</title>
  <meta name="theme-color" content="#080b1a" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    /* --- CORE VARIABLES --- */
    :root{
      --bg-app: #080b1a; 
      --card-bg: #10152b; 
      --card-border: rgba(66, 153, 225, 0.15);
      
      --text-main: #e2e8f0;
      --text-muted: #94a3b8;
      
      /* COLORS (RGB) */
      --c-wl: 34, 211, 238;   /* Cyan */
      --c-in: 59, 130, 246;   /* Blue */
      --c-tb: 245, 158, 11;   /* Orange */
      --c-sp: 239, 68, 68;    /* Red */
      --c-rn: 167, 139, 250;  /* Purple */
      --c-green: 16, 185, 129;
      --c-rn-real: 34, 197, 94;
      --c-acc: 250, 204, 21;  /* Yellow */

      --font-sans: 'Inter', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      
      --nav-height: 65px;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    ::-webkit-scrollbar { display: none; }
    
    html, body { 
       height: 100%; margin: 0; overflow: hidden; 
       background: var(--bg-app); font-family: var(--font-sans); color: var(--text-main);
       font-size: 15px; 
       -ms-overflow-style: none; scrollbar-width: none;
    }
    
    .app-container { display: flex; flex-direction: column; height: 100%; max-width: 600px; margin: 0 auto; background: var(--bg-app); position: relative; }
    
    /* LOGIN SCREEN STYLES */
    #login-view {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #060818 0%, #1a203c 100%);
      z-index: 9999; display: flex; flex-direction: column;
      align-items: center; justify-content: center; padding: 20px;
    }
    .login-card {
      width: 100%; max-width: 360px;
      background: rgba(16, 21, 43, 0.8);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px; padding: 30px 24px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      text-align: center;
    }
    .login-logo {
      width: 140px; height: 50px; margin: 0 auto 20px;
      background-color: rgba(255,255,255,0.95); border-radius: 12px;
      background-image: url('https://ycthhachfxczwkburnfa.supabase.co/storage/v1/object/public/Image/Logo%20AVC.png');
      background-size: 90%; background-position: center; background-repeat: no-repeat;
    }
    .login-title { font-size: 20px; font-weight: 700; color: white; margin-bottom: 6px; }
    .login-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 30px; }
    
    .inp-group { margin-bottom: 16px; text-align: left; }
    .inp-label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; margin-left: 4px; }
    .login-input {
      width: 100%; padding: 14px; border-radius: 12px;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      color: white; font-size: 14px; outline: none; transition: 0.2s;
    }
    .login-input:focus { border-color: var(--c-in); background: rgba(59, 130, 246, 0.1); }
    
    .btn-login {
      width: 100%; padding: 14px; border-radius: 12px; margin-top: 10px;
      background: linear-gradient(90deg, #3b82f6, #2563eb);
      color: white; font-weight: 700; font-size: 15px; border: none; cursor: pointer;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }
    .btn-login:active { transform: scale(0.98); opacity: 0.9; }
    .login-error { color: #ef4444; font-size: 12px; margin-top: 15px; min-height: 18px; }

    /* APP LAYOUT (HIDDEN BY DEFAULT) */
    #main-view { display: none; }

    /* TOPBAR */
    .topbar {
      flex-shrink: 0; padding: 12px 16px; 
      background: rgba(16, 21, 43, 0.95); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--card-border); display: flex; justify-content: space-between; align-items: center; z-index: 20;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    
    /* LOGO FIX */
    .logo-container {
      width: 90px; height: 38px;
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      padding: 2px;
    }
    .logo-container img {
      width: 100%; height: 100%;
      object-fit: contain; 
    }

    .brand-text h1 { margin: 0; font-size: 16px; font-weight: 700; color: white; }
    .brand-text small { font-size: 12px; color: rgb(var(--c-wl)); display: block; margin-top: 0px; }
    .status-badge { font-size: 11px; font-weight: 700; background: rgba(16, 185, 129, 0.15); color: rgb(var(--c-green)); padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(16, 185, 129, 0.3); }

    /* CONTENT */
    .main-content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 80px; }
    .tab-pane { display: none; animation: fadeUp 0.3s ease; }
    .tab-pane.active { display: block; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- DASHBOARD STYLES --- */
    .safety-card {
      background: linear-gradient(145deg, rgba(16, 21, 43, 1), rgba(6, 50, 90, 0.3));
      border-radius: 18px; border: 1px solid var(--card-border);
      padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 25px rgba(0,0,0,0.4);
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .card-title { font-size: 13px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .warning-tag { background: rgba(245, 158, 11, 0.2); color: rgb(var(--c-tb)); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; border: 1px solid rgba(245, 158, 11, 0.3); }
    
    .big-number-box { text-align: center; margin-bottom: 20px; }
    .big-label { font-size: 14px; color: var(--text-muted); margin-bottom: 4px; }
    .big-value { font-size: 56px; font-weight: 800; color: rgb(var(--c-wl)); line-height: 1; text-shadow: 0 0 30px rgba(34, 211, 238, 0.25); font-family: var(--font-sans); letter-spacing: -2px; }
    .unit-sub { font-size: 20px; font-weight: 600; color: var(--text-muted); margin-left: 4px; }

    .level-list { display: flex; flex-direction: column; gap: 12px; }
    .level-item { display: flex; align-items: center; font-size: 13px; color: var(--text-main); font-weight: 500; }
    .lvl-name { white-space: nowrap; }
    .lvl-dots { flex: 1; border-bottom: 1px dashed rgba(255,255,255,0.1); margin: 0 10px; position: relative; top: -3px; }
    .lvl-diff { font-family: var(--font-mono); font-weight: 700; font-size: 13px; }
    
    .lvl-kt { color: #ef4444; } 
    .lvl-dbt { color: #f59e0b; } 
    .lvl-dl { color: #3b82f6; }  
    .lvl-ch { color: #a855f7; }
    .lvl-min { color: #22d3ee; } 
  
    .section-title { font-size: 13px; font-weight: 700; color: var(--text-muted); margin: 24px 0 10px 4px; text-transform: uppercase; display: block; letter-spacing: 0.5px; }
    
    /* NEW GRID STYLES */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 16px; }
    
    .stat-box {
      background: rgba(16, 21, 43, 0.6); 
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px; padding: 14px 6px; text-align: center;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative; overflow: hidden;
    }
    /* Flow Group */
    .stat-box.flow { background: linear-gradient(180deg, rgba(59, 130, 246, 0.05) 0%, rgba(16, 21, 43, 0.8) 100%); border-color: rgba(59, 130, 246, 0.15); }
    /* Vol Group */
    .stat-box.vol { background: linear-gradient(180deg, rgba(245, 158, 11, 0.05) 0%, rgba(16, 21, 43, 0.8) 100%); border-color: rgba(245, 158, 11, 0.15); }
    /* Rain Group */
    .stat-box.rain { background: linear-gradient(180deg, rgba(167, 139, 250, 0.08) 0%, rgba(16, 21, 43, 0.8) 100%); border-color: rgba(167, 139, 250, 0.2); }

    .stat-label { font-size: 10px; color: #94a3b8; margin-bottom: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
    .stat-val { font-size: 18px; font-weight: 800; color: white; font-family: var(--font-mono); line-height: 1.2; }
    .stat-sub { font-size: 10px; color: #64748b; margin-top: 3px; font-weight: 500; }
    
    .forecast-row {
      background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 14px;
      padding: 14px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;
    }
    .fc-info { display: flex; flex-direction: column; gap: 3px; }
    .fc-title { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
    .fc-desc { font-size: 11px; color: #64748b; }
    .fc-range { font-family: var(--font-mono); font-size: 16px; color: var(--text-main); font-weight: 700; }
    .fc-highlight { color: rgb(var(--c-wl)); }
    .fc-rain { color: rgb(var(--c-green)); }

    /* CARD GENERAL */
    .card {
      background: var(--card-bg); border-radius: 16px; border: 1px solid var(--card-border);
      padding: 14px; margin-bottom: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      position: relative; overflow: hidden;
    }
    .cardHead { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
    .cardHead b { font-size: 14px; color: var(--text-muted); text-transform: uppercase; }

    /* Controls */
    .row { display: flex; gap: 10px; margin-bottom: 14px; align-items: flex-end; }
    .control { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    label { font-size: 12px; color: var(--text-muted); }
    input[type=date], .btn-action, button {
      background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); color: white;
      padding: 10px; border-radius: 10px; font-family: var(--font-sans); width: 100%; font-size: 14px; outline:none;
    }
    .btn-action, button { background: rgba(59, 130, 246, 0.2); color: #60a5fa; font-weight: 700; width: auto; white-space: nowrap; padding: 10px 18px; cursor: pointer; }
    
    .chip { padding:4px 10px; border-radius:99px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03); color:var(--text-muted); font-size:11px; }

    /* Tabs & Chart */
    .tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .tab {
      padding: 6px 12px; border-radius: 99px; border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.03); color: var(--text-muted); font-size: 12px; font-weight: 600;
      cursor: pointer; display: flex; align-items: center; gap: 5px;
    }
    .tab.active { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: white; }
    .swatch { width: 8px; height: 8px; border-radius: 50%; }
    canvas { width: 100% !important; height: 320px !important; }

    /* --- TABLE OPTIMIZED FOR MOBILE --- */
    .table-container { 
      overflow-x: auto; 
      -webkit-overflow-scrolling: touch; 
      border-radius: 12px; 
      border: 1px solid rgba(255,255,255,0.08); 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 12px; /* Font nh·ªè h∆°n tr√™n mobile */
      white-space: nowrap; 
    }
    
    th { 
      background: #161e33; 
      color: #94a3b8; 
      padding: 8px 4px; /* Gi·∫£m padding header */
      text-align: center; 
      font-weight: 700; 
      font-size: 10px; /* Header nh·ªè g·ªçn */
      text-transform: uppercase; 
      font-family: var(--font-sans);
      letter-spacing: 0.3px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    td { 
      padding: 8px 4px; /* Gi·∫£m padding cell */
      border-bottom: 1px solid rgba(255,255,255,0.04); 
      text-align: center; 
      font-family: var(--font-sans);
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }
    
    /* C·ªôt ƒë·∫ßu ti√™n (Th·ªùi gian): Thu g·ªçn t·ªëi ƒëa */
    td:first-child { 
      text-align: left; 
      padding-left: 10px; 
      position: sticky; 
      left: 0; 
      background: #0f1426; 
      z-index: 1; 
      border-right: 1px solid rgba(255,255,255,0.08); 
      color: var(--text-main); 
      font-weight: 600;
      font-size: 11px; /* Font nh·ªè cho th·ªùi gian */
      width: 60px; /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông n·∫øu c·∫ßn */
    }

    /* Accordion */
    .list-item { background: var(--card-bg); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; }
    .accordion-header { display: flex; gap: 12px; padding: 14px; align-items: flex-start; cursor: pointer; }
    .icon-box { width: 36px; height: 36px; border-radius: 10px; background: rgba(59,130,246,0.15); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
    .item-content h4 { margin: 0 0 4px; font-size: 14px; color: var(--text-main); font-weight: 600; line-height: 1.3; }
    .item-content p { margin: 0; font-size: 12px; color: var(--text-muted); line-height: 1.4; }
    .accordion-body { display: none; padding: 0 14px 14px 62px; color: var(--text-muted); font-size: 13px; line-height: 1.6; white-space: pre-wrap; }
    .accordion-body.open { display: block; }

    /* Nav */
    .bottom-nav {
      position: absolute; bottom: 0; left: 0; right: 0; height: var(--nav-height);
      background: rgba(6, 8, 20, 0.98); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.08);
      display: grid; grid-template-columns: repeat(5, 1fr); z-index: 100;
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #526071; cursor: pointer; }
    .nav-item.active { color: rgb(var(--c-in)); }
    .nav-item svg { width: 24px; height: 24px; fill: currentColor; }
    .nav-item span { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }

    .toast{ position:fixed; left:50%; bottom:80px; transform:translateX(-50%); padding:10px 16px; border-radius:24px; background:rgba(255,255,255,0.1); backdrop-filter:blur(5px); color:white; font-size:12px; display:none; z-index: 200; }
  </style>
</head>
<body>

<div id="login-view">
  <div class="login-card">
    <div class="login-logo"></div>
    <div class="login-title">ƒêƒÉng Nh·∫≠p H·ªá Th·ªëng</div>
    <div class="login-desc">H·ªá th·ªëng h·ªó tr·ª£ v·∫≠n h√†nh h·ªì ch·ª©a th·ªßy ƒëi·ªán A V∆∞∆°ng</div>
    
    <div class="inp-group">
      <label class="inp-label">Email</label>
      <input type="email" id="loginEmail" class="login-input" placeholder="nhanvien@avuong.vn">
    </div>
    <div class="inp-group">
      <label class="inp-label">M·∫≠t kh·∫©u</label>
      <input type="password" id="loginPass" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>

    <button class="btn-login" onclick="handleLogin()">ƒêƒÇNG NH·∫¨P</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<div class="app-container" id="main-view">
  <div class="topbar">
    <div class="brand">
      <div class="logo-container">
          <img src="https://ycthhachfxczwkburnfa.supabase.co/storage/v1/object/public/Image/Logo%20AVC.png" alt="Logo AVC">
      </div>
      <div class="brand-text">
        <h1>AV ‚Ä¢ Reservoir Operation ‚Ä¢ AI</h1>
        <small id="lastUpdate" style="margin-left: 8px; font-weight: 500;">--:--</small>
      </div>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <button onclick="window.location.reload()" style="background:rgba(59,130,246,0.15); border:1px solid rgba(59,130,246,0.3); color:#60a5fa; padding:0; width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer; margin-right:4px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
      </button>
      
      <div class="status-badge">ONLINE</div>
      <button onclick="handleLogout()" style="background:rgba(239,68,68,0.2); border:1px solid rgba(239,68,68,0.3); color:#ef4444; padding:4px 8px; font-size:10px; width:auto;">
        Tho√°t
      </button>
    </div>
  </div>

  <div class="main-content">
    
    <div id="tab-overview" class="tab-pane active">
      
      <section class="safety-card">
        <div class="card-header">
          <span class="card-title">An To√†n C√¥ng Tr√¨nh</span>
          <span class="warning-tag" id="floodStatus">B√¨nh th∆∞·ªùng</span>
        </div>
        
        <div class="big-number-box">
          <div class="big-label">M·ª±c n∆∞·ªõc h·ªì hi·ªán t·∫°i</div>
          <div class="big-value">
            <span id="txtWL">---</span><span class="unit-sub">m</span>
          </div>
        </div>

        <div class="level-list">
          <div class="level-item">
            <span class="lvl-name lvl-kt">MN Ki·ªÉm tra (382.2)</span><span class="lvl-dots"></span><span class="lvl-diff lvl-kt" id="diff_KiemTra">--</span>
          </div>
          <div class="level-item">
            <span class="lvl-name lvl-dbt" style="font-weight:700;">MN D√¢ng b√¨nh th∆∞·ªùng (380.0)</span><span class="lvl-dots"></span><span class="lvl-diff lvl-dbt" id="diff_MNDBT">--</span>
          </div>
          <div class="level-item">
            <span class="lvl-name lvl-dl" id="lbl_DonLu">MN Cao nh·∫•t tr∆∞·ªõc l≈© (376.0)</span><span class="lvl-dots"></span><span class="lvl-diff lvl-dl" id="diff_DonLu">--</span>
          </div>
          
          <div class="level-item">
            <span class="lvl-name lvl-min">MN ƒë√≥n l≈© th·∫•p nh·∫•t (370.0)</span><span class="lvl-dots"></span><span class="lvl-diff lvl-min" id="diff_DonLuMin">--</span>
          </div>

          <div class="level-item">
            <span class="lvl-name lvl-ch">MN Ch·∫øt (340.0)</span><span class="lvl-dots"></span><span class="lvl-diff lvl-ch" id="diff_Chet">--</span>
          </div>
        </div>
      </section>

      <span class="section-title">S·ªë li·ªáu v·∫≠n h√†nh</span>
      <div class="stats-grid">
        <div class="stat-box flow">
          <span class="stat-label">Q v·ªÅ (m¬≥/s)</span>
          <span class="stat-val" style="color:rgb(var(--c-in))" id="txtQin">--</span>
        </div>
        <div class="stat-box flow">
          <span class="stat-label">Q m√°y (m¬≥/s)</span>
          <span class="stat-val" style="color:rgb(var(--c-tb))" id="txtQtb">--</span>
        </div>
        <div class="stat-box flow">
          <span class="stat-label">Q x·∫£ (m¬≥/s)</span>
          <span class="stat-val" style="color:rgb(var(--c-sp))" id="txtQsp">0</span>
        </div>
        
        <div class="stat-box vol">
          <span class="stat-label">Dung t√≠ch (Tr.m¬≥)</span>
          <span class="stat-val" style="color:#fff" id="txtVol">--</span>
        </div>
        <div class="stat-box vol">
          <span class="stat-label">% To√†n b·ªô</span>
          <span class="stat-val" style="color:rgb(var(--c-wl))" id="txtPctTotal">--%</span>
        </div>
        <div class="stat-box vol">
          <span class="stat-label">% H·ªØu √≠ch</span>
          <span class="stat-val" style="color:rgb(var(--c-wl))" id="txtPctUseful">--%</span>
        </div>
        
        <div class="stat-box rain">
          <span class="stat-label">M∆∞a 1h (mm)</span>
          <span class="stat-val" style="color:rgb(var(--c-rn))" id="txtRain1h">--</span>
        </div>
        <div class="stat-box rain">
          <span class="stat-label">M∆∞a ng√†y D</span>
          <span class="stat-val" style="color:rgb(var(--c-rn))" id="txtRainDay">--</span>
        </div>
        <div class="stat-box rain">
          <span class="stat-label">M∆∞a D-1</span>
          <span class="stat-val" style="color:#cbd5e1" id="txtRainD1">--</span>
        </div>
      </div>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px;">
          <div style="background:rgba(255,255,255,0.03); border-radius:10px; padding:10px; text-align:center; border:1px solid rgba(255,255,255,0.05);">
             <div style="font-size:10px; color:#94a3b8; text-transform:uppercase; margin-bottom:2px;">DT H·ªØu √≠ch c√≤n l·∫°i</div>
             <div style="font-family:var(--font-mono); font-weight:700; color:#e2e8f0;" id="txtVolUsefulLeft">--</div>
          </div>
          <div style="background:rgba(255,255,255,0.03); border-radius:10px; padding:10px; text-align:center; border:1px solid rgba(255,255,255,0.05);">
             <div style="font-size:10px; color:#94a3b8; text-transform:uppercase; margin-bottom:2px;">DT Tr·ªëng (ƒë·∫øn MNDBT)</div>
             <div style="font-family:var(--font-mono); font-weight:700; color:#e2e8f0;" id="txtVolRemain">--</div>
          </div>
      </div>

      <span class="section-title">D·ª± b√°o 7 ng√†y t·ªõi</span>
      <div class="forecast-row">
        <div class="fc-info">
          <span class="fc-title">L∆∞u l∆∞·ª£ng v·ªÅ (Min-Max)</span>
          <span class="fc-desc">D·ª± b√°o t·ªï h·ª£p Ensemble</span>
        </div>
        <div class="fc-range fc-highlight" id="fcFlowRange">-- - --</div>
      </div>
      <div class="forecast-row">
        <div class="fc-info">
          <span class="fc-title">M∆∞a ng√†y (Min-Max)</span>
          <span class="fc-desc">L∆∞·ª£ng m∆∞a t√≠ch l≈©y 24h</span>
        </div>
        <div class="fc-range fc-rain" id="fcRainRange">-- - --</div>
      </div>
    </div>

    <div id="tab-chart" class="tab-pane">
      <section class="card">
        <div class="cardHead"><b>ƒêi·ªÅu khi·ªÉn</b></div>
        <div class="cardBody">
          <div class="row">
            <div class="control"><label>Ng√†y xem</label><input id="day" type="date"></div>
            <div class="control" style="flex:0"><label>&nbsp;</label><button id="btnLoad">T·∫£i l·∫°i</button></div>
          </div>
        </div>
      </section>
      <section class="card">
        <div class="cardHead"><b>Bi·ªÉu ƒë·ªì</b> <span class="chip" id="chartRange">...</span></div>
        <div class="cardBody">
          <div class="tabs" id="tabs"></div>
          <div style="height:320px; position:relative;">
            <canvas id="chart"></canvas>
          </div>
        </div>
      </section>
    </div>

    <div id="tab-forecast" class="tab-pane">
      <div class="card">
        <div class="cardHead">
            <b>B·∫£n tin D·ª± b√°o (10 g·∫ßn nh·∫•t)</b> 
            <button onclick="loadForecasts()" style="width:auto; padding:6px 12px; font-size:11px; margin-left:auto; background:rgba(59,130,246,0.2);">C·∫≠p nh·∫≠t</button>
        </div>
        <div id="forecast-list" style="padding:0;">
          <div style="padding:20px; text-align:center; color:var(--text-muted); font-size:12px;">ƒêang t·∫£i b·∫£n tin...</div>
        </div>
      </div>
    </div>

    <div id="tab-data" class="tab-pane">
      <div class="card">
        <div class="cardHead"><b>24 gi·ªù g·∫ßn nh·∫•t (M·ªõi nh·∫•t)</b></div>
        <div style="padding:0; overflow:hidden;">
          <div class="table-container">
            <table id="dataTable">
              <thead>
                <tr>
                  <th style="color:white">Th·ªùi gian</th> 
                  <th style="color:rgb(34,211,238)">MNH</th> 
                  <th style="color:rgb(59,130,246)">Q v·ªÅ</th> 
                  <th style="color:rgb(250,204,21)">Q m√°y</th> 
                  <th style="color:rgb(239,68,68)">Q x·∫£</th> 
                  <th style="color:rgb(52, 211, 153)">M∆∞a</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr><td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted)">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-notif" class="tab-pane">
      <div class="card" style="background:transparent; border:none; box-shadow:none;">
        <div class="list-item" style="background:var(--card-bg); border-radius:16px; margin-bottom:10px; border:1px solid var(--card-border);">
          <div class="accordion-header">
             <div class="icon-box">üì¢</div>
             <div class="item-content">
                <h4>K·∫ø ho·∫°ch ch·∫°y m√°y T·∫øt 2026</h4>
                <p>Th√¥ng b√°o ph∆∞∆°ng th·ª©c v·∫≠n h√†nh ƒë·∫£m b·∫£o ƒëi·ªán √°p...</p>
             </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="cardBody" style="text-align:center; padding:30px 20px;">
           <div class="logo-container" style="width:120px; height:46px; margin:0 auto 15px;">
              <img src="https://ycthhachfxczwkburnfa.supabase.co/storage/v1/object/public/Image/Logo%20AVC.png" alt="Logo AVC">
          </div>
          <h3 style="color:var(--text-main); margin:0 0 5px;">C√¥ng ty CP Th·ªßy ƒëi·ªán A V∆∞∆°ng</h3>
          <p style="color:var(--text-muted); font-size:13px; margin-bottom:25px;">Th√¥n Dung, x√£ Th·∫°nh M·ªπ, TP. ƒê√† N·∫µng</p>
          <div style="text-align:left; background:rgba(255,255,255,0.03); border-radius:12px; padding:15px; margin-bottom:10px;">
            <small style="color:var(--text-muted);">Hotline Admin</small>
            <div style="font-size:16px; font-weight:600; color:#3b82f6;">0963.43.43.10</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="goTab('overview', this)">
      <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg><span>T·ªïng quan</span>
    </div>
    <div class="nav-item" onclick="goTab('chart', this)">
      <svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg><span>Bi·ªÉu ƒë·ªì</span>
    </div>
    <div class="nav-item" onclick="goTab('forecast', this)">
      <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg><span>D·ª± b√°o</span>
    </div>
    <div class="nav-item" onclick="goTab('data', this)">
      <svg viewBox="0 0 24 24"><path d="M4 14h4v-4H4v4zm0 5h4v-4H4v4zM4 9h4V5H4v4zm5 5h12v-4H9v4zm0 5h12v-4H9v4zM9 5v4h12V5H9z"/></svg><span>S·ªë li·ªáu</span>
    </div>
    <div class="nav-item" onclick="goTab('notif', this)">
      <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg><span>Th√¥ng b√°o</span>
    </div>
  </nav>

</div>
<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  // --- HELPERS ---
  const $ = (id) => document.getElementById(id);
  const fmt2 = new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 2, minimumFractionDigits: 2 });
  const fmt1 = new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 1, minimumFractionDigits: 1 });
  const fmt0 = new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 0 });
  
  function getRain(r){ return r && r.rainfall_mm !== undefined ? Number(r.rainfall_mm) : 0; }
  
  function getValSafe(val) {
      if (val === null || val === undefined) return 0;
      return Number(val);
  }

  function getFlowFc(r){
    if(!r) return 0;
    if(r.inflow_m3s !== undefined && r.inflow_m3s !== null) return Number(r.inflow_m3s);
    return r.inflow !== undefined ? Number(r.inflow) : 0;
  }
  function parseLiteral(iso) {
    if(!iso) return null;
    const datePart = iso.substring(0, 10); 
    const timePart = iso.substring(11, 16); 
    const [y,m,d] = datePart.split('-');
    return { day: d, month: m, year: y, time: timePart };
  }
  function extractDateVN(iso) {
      const d = new Date(iso);
      if(isNaN(d.getTime())) return null;
      const vnTime = new Date(d.getTime() + 7 * 60 * 60 * 1000);
      const day = String(vnTime.getUTCDate()).padStart(2, '0');
      const month = String(vnTime.getUTCMonth() + 1).padStart(2, '0');
      return `${day}/${month}`;
  }
  function getYearMD(iso) {
      const d = new Date(iso);
      if(isNaN(d.getTime())) return null;
      const vnTime = new Date(d.getTime() + 7 * 60 * 60 * 1000);
      return vnTime.toISOString().split('T')[0];
  }

  function formatTimeVN(iso){ const p = parseLiteral(iso); return p ? p.time : "-"; }
  function formatDateTimeVN(iso){ const p = parseLiteral(iso); return p ? `${p.time} ${p.day}/${p.month}/${p.year}` : "-"; }
  function formatChartLabel(iso){ const p = parseLiteral(iso); return p ? `${p.time} ${p.day}/${p.month}` : "-"; }
  
  function formatTableTime(iso) {
      const p = parseLiteral(iso);
      if(!p) return "-";
      const h = parseInt(p.time.split(':')[0]); 
      return `${h}h ${p.day}/${p.month}`;
  }

  function rgba(rgb,a){ return `rgba(${rgb}, ${a})`; }
  function toast(msg){ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none", 2500); }
  
  function formatToVNTime(isoString) {
      const date = new Date(isoString);
      if (isNaN(date.getTime())) return isoString; 
      const vnDate = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Ho_Chi_Minh"}));
      const hh = String(vnDate.getHours()).padStart(2, '0');
      const mm = String(vnDate.getMinutes()).padStart(2, '0');
      const dd = String(vnDate.getDate()).padStart(2, '0');
      const mo = String(vnDate.getMonth() + 1).padStart(2, '0');
      const yyyy = vnDate.getFullYear();
      return `${hh}:${mm} ${dd}/${mo}/${yyyy}`;
  }

  // --- CONFIG ---
  const SB_URL = "https://ycthhachfxczwkburnfa.supabase.co";
  const SB_KEY = "sb_publishable_Q0KbTLPBE4owO72Mz-GN6A_khF9z_Ss";
  
  // CONSTANTS
  const RES_CONST = {
    WL_MAX_CHECK: 382.2, WL_NORMAL: 380.0, WL_FLOOD: 376.0, WL_FLOOD_MIN: 370.0,
    WL_DEAD: 340.0, VOL_DEAD: 77.0, VOL_MAX: 343.5       
  };

  // --- COLORS ---
  const C = {
    WL: '34, 211, 238',   /* Cyan */
    IN: '59, 130, 246',   /* Blue */
    TB: '245, 158, 11',   /* Orange */
    SP: '239, 68, 68',    /* Red */
    RN: '167, 139, 250',  /* Purple */
    IF: '255, 152, 0',    /* Forecast */
    RF: '34, 197, 94',    /* Rain Real */
    ACC: '250, 204, 21'   /* Accumulate */
  };

  // --- STATE ---
  let sb = null, chart = null;
  let currentTab = "WL_24H";
  
  const tabMeta = {
    WL_24H: { name:"MNH 24h", hint:"M·ª±c n∆∞·ªõc 24h qua", color: C.WL },
    FLOW_24H: { name:"Q 24h", hint:"D√≤ng ch·∫£y 24h qua", color: C.IN },
    WL_7D: { name:"MNH 7D", hint:"M·ª±c n∆∞·ªõc 7 ng√†y", color: C.WL },
    FLOW_7D: { name:"Q T·ªïng h·ª£p", hint:"Q v·ªÅ/m√°y/x·∫£ 7 ng√†y", color: C.IN },
    
    // N√öT SO S√ÅNH V7 (THAY TH·∫æ V8)
    IN_OBS_FC_V7: { name:"Q V·ªÅ vs DB (V7)", hint:"Th·ª±c t·∫ø vs M√¥ h√¨nh V7", color: '34, 197, 94' }, 
    IN_OBS_FC_MIX: { name:"Q V·ªÅ vs DB (Mixed)", hint:"Th·ª±c t·∫ø vs M√¥ h√¨nh Mixed (M∆∞a th·ª±c + DB)", color: '233, 30, 99' }, 
    IN_OBS_FC_AI: { name:"Q V·ªÅ vs DB (AI)", hint:"Th·ª±c t·∫ø vs M√¥ h√¨nh AI V1 (T·ª± h·ªçc)", color: '156, 39, 176' }, 

    IN_FC_7D: { name:"Q D·ª± b√°o", hint:"D·ª± b√°o 7 ng√†y t·ªõi (Ensemble)", color: C.IF },
    RF_DAILY_FC: { name:"M∆∞a Ng√†y", hint:"M∆∞a ng√†y & L≈©y k·∫ø", color: C.RN },
    RF_HOURLY_ACC: { name:"M∆∞a Gi·ªù", hint:"M∆∞a gi·ªù & L≈©y k·∫ø", color: C.RN },
    RF_COMPARE: { name:"M∆∞a Th·ª±c vs DB", hint:"So s√°nh m∆∞a Th·ª±c & DB", color: C.RF }
  };
  
  const state = { 
    hourly24h: [], hourly3D: [], hourly7D_Obs: [],
    inflowFc_V7: [], inflowFc_Mix: [], inflowFc_AI: [], 
    rainFc: [], rainObs7D: [], rain24hRaw: [], 
    latest24h: [], fcEnsemble: {}, 
    lastObs: null, rainAtHour: 0, rain24hSum: 0, storage: null 
  };

  // --- INIT ---
  window.addEventListener("load", () => {
    const tc = $("tabs");
    Object.keys(tabMeta).forEach(k => {
      const t = document.createElement("span"); 
      t.className = `tab ${k===currentTab?'active':''}`;
      t.innerHTML = `<span class="swatch" style="background:rgb(${tabMeta[k].color})"></span>${tabMeta[k].name}`;
      t.onclick = () => {
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active"); currentTab=k; renderChart();
      };
      tc.appendChild(t);
    });

    const d = new Date();
    const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0');
    $("day").value = `${y}-${m}-${day}`;
    
    if(window.supabase) {
        sb = window.supabase.createClient(SB_URL, SB_KEY);
        sb.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                showApp();
            } else {
                showLogin();
            }
        });
    }
  });

  async function handleLogin() {
      const email = $("loginEmail").value;
      const password = $("loginPass").value;
      const errBox = $("loginError");
      if(!email || !password) { errBox.textContent = "Vui l√≤ng nh·∫≠p Email v√† M·∫≠t kh·∫©u"; return; }
      errBox.textContent = "ƒêang ki·ªÉm tra...";
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) { errBox.textContent = "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + error.message; } else { showApp(); }
  }

  async function handleLogout() { await sb.auth.signOut(); showLogin(); }

  function showApp() { $("login-view").style.display = "none"; $("main-view").style.display = "flex"; loadData(); }
  function showLogin() { $("login-view").style.display = "flex"; $("main-view").style.display = "none"; $("loginEmail").value = ""; $("loginPass").value = ""; $("loginError").textContent = ""; }

  // --- DATA LOADING ---
  async function loadData() {
    const btn = $("btnLoad"); btn.disabled=true; btn.innerText="...";
    try {
      const dateVal = $("day").value;
      const [y,m,d] = dateVal.split('-');
      const dSelected = new Date(Number(y), Number(m)-1, Number(d));
      
      const tStart = dateVal + "T00:00:00Z";
      const tEnd = dateVal + "T23:59:59Z";
      const t7DaysAgo = new Date(dSelected.getTime() - 6*86400000).toISOString();
      const tFcStart = new Date(dSelected.getTime() - 1*86400000).toISOString();
      const tFcEnd = new Date(dSelected.getTime() + 10*86400000).toISOString();
      const now = new Date();
      const future7d = new Date(now.getTime() + 7 * 24 * 3600 * 1000).toISOString();

      const [res1, res2, res4, res5, res6, res7, res8, resLatest, resRainFc, resFcFuture, resRainFcFuture] = await Promise.all([
        sb.from('reservoir_hourly_data').select('*').gte('time', tStart).lte('time', tEnd).order('time', {ascending: true}),
        sb.from('inflow_forecast').select('*').gte('forecast_time', tFcStart).lte('forecast_time', tFcEnd).order('created_at', {ascending: false}), 
        sb.from('reservoir_hourly_data').select('time, inflow').gte('time', tFcStart).lte('time', tEnd).order('time', {ascending: true}), 
        sb.from('rainfall_observed').select('*').gte('time', tStart).lte('time', tEnd).order('time', {ascending: true}), 
        sb.from('v_current_storage').select('*').order('time', {ascending: false}).limit(1), 
        sb.from('reservoir_hourly_data').select('*').gte('time', t7DaysAgo).lte('time', tEnd).order('time', {ascending: true}), 
        sb.from('rainfall_observed').select('*').gte('time', t7DaysAgo).lte('time', tEnd).order('time', {ascending: true}),
        sb.from('reservoir_hourly_data').select('*').order('time', {ascending: false}).limit(24),
        sb.from('rainfall_forecast').select('*').gte('forecast_time', tFcStart).lte('forecast_time', tFcEnd).order('created_at', {ascending: false}),
        sb.from('inflow_forecast').select('*').gte('forecast_time', now.toISOString()).lte('forecast_time', future7d),
        sb.from('rainfall_forecast').select('*').gte('forecast_time', now.toISOString()).lte('forecast_time', future7d)
      ]);

      state.hourly24h = getLatestUniqueData(res1.data, 'time');
      
      const allForecasts = res2.data || [];
      state.inflowFc_V7 = getLatestUniqueData(allForecasts.filter(i => i.source === 'rf2q_v7'), 'forecast_time');
      state.inflowFc_Mix = getLatestUniqueData(allForecasts.filter(i => i.source === 'rf2q_mixed_real_fc'), 'forecast_time');
      state.inflowFc_AI = getLatestUniqueData(allForecasts.filter(i => i.source === 'rf2q_ai_v1'), 'forecast_time');

      state.rainFc = getLatestUniqueData(resRainFc.data, 'forecast_time').map(i=>({forecast_time:i.forecast_time, rainfall_mm:Number(i.rainfall_mm)||0}));
      
      const mapFc = {}; (res2.data||[]).forEach(i => { if(!mapFc[i.forecast_time]) mapFc[i.forecast_time]=[]; mapFc[i.forecast_time].push(i); });
      state.fcEnsemble = mapFc;

      state.hourly3D = getLatestUniqueData(res4.data, 'time');
      state.hourly7D_Obs = getLatestUniqueData(res7.data, 'time'); 
      state.rainObs7D = getLatestUniqueData(res8.data, 'time'); // Data m∆∞a 7 ng√†y qua
      state.rain24hRaw = getLatestUniqueData(res4.data, 'time'); // Data m∆∞a ng√†y hi·ªán t·∫°i (ƒë√£ l·ªçc theo tStart-tEnd ·ªü tr√™n)
      
      state.latest24h = (resLatest.data || []); 
      state.storage = res6.data ? res6.data[0] : null;
      state.latest24h.reverse();
      state.lastObs = state.latest24h.length ? state.latest24h[state.latest24h.length-1] : null;

      let rainCur = 0;
      if (state.lastObs) {
        const tObs = new Date(state.lastObs.time).getTime();
        const match = state.rain24hRaw.find(r => Math.abs(new Date(r.time).getTime() - tObs) < 1800000); 
        if(match) rainCur = getRain(match);
      }
      state.rainAtHour = rainCur;
      state.rain24hSum = state.rain24hRaw.reduce((s,r)=>s+getRain(r), 0);

      renderOverview(resFcFuture.data, resRainFcFuture.data);
      renderChart();
      if(document.getElementById('tab-data').classList.contains('active')) loadTableData();
      if(document.getElementById('tab-forecast').classList.contains('active')) loadForecasts();
      
      toast("ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu");

    } catch(e){ console.error(e); toast("L·ªói k·∫øt n·ªëi"); }
    finally{ btn.disabled=false; btn.innerText="T·∫£i l·∫°i"; }
  }

  function getLatestUniqueData(arr, key) {
    if(!arr) return [];
    const map = new Map();
    [...arr].sort((a,b) => new Date(b.created_at || b.time) - new Date(a.created_at || a.time)).forEach(i => { if(!map.has(i[key])) map.set(i[key], i); });
    return Array.from(map.values()).sort((a,b) => new Date(a[key]) - new Date(b[key]));
  }
  
  function aggregateRainByDay(data, timeKey, valueKey) {
    const map = {};
    data.forEach(r => { 
        const dateStr = extractDateVN(r[timeKey]);
        if(dateStr) { 
            const val = getValSafe(r[valueKey]);
            map[dateStr] = (map[dateStr] || 0) + val; 
        } 
    });
    return map;
  }
  
  function aggregateByDay(data, timeKey) { return aggregateRainByDay(data, timeKey, 'rainfall_mm'); }

  function renderOverview(fcFlowData, fcRainData){
    const l = state.lastObs;
    if (!l) return;
    const wl = l.water_level;
    if($("txtWL")) $("txtWL").textContent = fmt2.format(wl);
    if($("lastUpdate")) {
      const p = parseLiteral(l.time); 
      if(p) { $("lastUpdate").textContent = `${p.time} ${p.day}/${p.month}`; }
    }
    const pDate = parseLiteral(l.time);
    let dlLimit = 376.0; let dlText = "376.0";
    if (pDate) {
        const d = parseInt(pDate.day, 10); const m = parseInt(pDate.month, 10);
        if ( (m === 11 && d >= 16) || (m === 12 && d <= 15) ) { dlLimit = 380.0; dlText = "377.0 - 380.0"; }
    }
    const lblDL = $("lbl_DonLu");
    if(lblDL) lblDL.innerText = `MN Cao nh·∫•t tr∆∞·ªõc l≈© (${dlText})`;
    const setDiff = (id, val) => {
      const diff = wl - val; const el = $(id);
      if(el){ el.innerText = `${diff > 0 ? "+" : ""}${fmt2.format(diff)}`; }
    };
    setDiff('diff_KiemTra', RES_CONST.WL_MAX_CHECK);
    setDiff('diff_MNDBT', RES_CONST.WL_NORMAL);
    setDiff('diff_DonLu', dlLimit); 
    setDiff('diff_DonLuMin', RES_CONST.WL_FLOOD_MIN);
    setDiff('diff_Chet', RES_CONST.WL_DEAD);
    const tag = $("floodStatus");
    if(tag) {
        if(wl >= RES_CONST.WL_FLOOD) { tag.innerText = "C·∫¢NH B√ÅO L≈®"; tag.style.color="rgb(var(--c-tb))"; tag.style.borderColor="rgb(var(--c-tb))"; tag.style.background="rgba(239,68,68,0.15)"; }
        else { tag.innerText = "B√åNH TH∆Ø·ªúNG"; tag.style.color="rgb(var(--c-green))"; tag.style.borderColor="rgb(var(--c-green))"; tag.style.background="rgba(16,185,129,0.15)"; }
    }
    if($("txtQin")) $("txtQin").textContent = fmt2.format(l.inflow);
    if($("txtQtb")) $("txtQtb").textContent = fmt2.format(l.turbine_flow);
    if($("txtQsp")) $("txtQsp").textContent = fmt2.format(l.spillway_flow);
    
    // RAIN CALCULATION
    if($("txtRain1h")) $("txtRain1h").textContent = fmt1.format(state.rainAtHour);
    if($("txtRainDay")) $("txtRainDay").textContent = fmt1.format(state.rain24hSum); // Rain Day D
    
    // Calc Rain D-1
    const dMinus1 = new Date($("day").value);
    dMinus1.setDate(dMinus1.getDate() - 1);
    const dMinus1Str = getYearMD(dMinus1.toISOString()); // YYYY-MM-DD in VN
    const rainD1Sum = state.rainObs7D.reduce((s, r) => {
        if (getYearMD(r.time) === dMinus1Str) return s + getRain(r);
        return s;
    }, 0);
    if($("txtRainD1")) $("txtRainD1").textContent = fmt1.format(rainD1Sum);


    let curVol = 0;
    if (state.storage && (state.storage.volume || state.storage.current_volume)) {
        curVol = Number(state.storage.volume || state.storage.current_volume);
    } else {
        if(wl > 340) curVol = RES_CONST.VOL_DEAD + ((wl - 340)/40)*(RES_CONST.VOL_MAX - RES_CONST.VOL_DEAD);
    }
    if($("txtVol")) $("txtVol").textContent = fmt2.format(curVol);
    const volUsefulCurrent = Math.max(0, curVol - RES_CONST.VOL_DEAD);
    if($("txtVolUsefulLeft")) $("txtVolUsefulLeft").textContent = fmt2.format(volUsefulCurrent);
    const pctUseful = (volUsefulCurrent / (RES_CONST.VOL_MAX - RES_CONST.VOL_DEAD)) * 100;
    if($("txtPctUseful")) $("txtPctUseful").textContent = fmt2.format(pctUseful) + "%";
    const volRemain = Math.max(0, RES_CONST.VOL_MAX - curVol);
    if($("txtVolRemain")) $("txtVolRemain").textContent = fmt2.format(volRemain);
    const pctTotal = (curVol / RES_CONST.VOL_MAX) * 100;
    if($("txtPctTotal")) $("txtPctTotal").textContent = fmt2.format(pctTotal) + "%";
    if(fcFlowData && fcFlowData.length){
        const flows = fcFlowData.map(f => getFlowFc(f));
        if($("fcFlowRange")) $("fcFlowRange").textContent = `${fmt2.format(Math.min(...flows))} - ${fmt2.format(Math.max(...flows))}`;
    }
    if(fcRainData && fcRainData.length){
        const dayMap = {};
        fcRainData.forEach(r => { const d = r.forecast_time.substring(0,10); dayMap[d] = (dayMap[d]||0) + Number(r.rainfall_mm); });
        const rains = Object.values(dayMap);
        if(rains.length && $("fcRainRange")) $("fcRainRange").textContent = `${fmt1.format(Math.min(...rains))} - ${fmt1.format(Math.max(...rains))}`;
    }
  }

  function renderChart(){
    if(chart) chart.destroy();
    const ctx = $("chart").getContext("2d");
    $("chartRange").textContent = tabMeta[currentTab].hint;

    const opts = {
      responsive:true, maintainAspectRatio:false, interaction:{mode:"index", intersect:false},
      plugins:{ legend:{labels:{color:"#9ca3af", font:{size:11}, boxWidth:12}} },
      scales:{
        x:{ticks:{color:"#64748b", font:{size:10}, maxRotation:0, autoSkip:true, maxTicksLimit:6}, grid:{color:"rgba(255,255,255,0.05)"}},
        y:{ticks:{color:"#64748b", font:{size:10}}, grid:{color:"rgba(255,255,255,0.05)"}}
      }
    };

    let labels=[], datasets=[]; 
    
    const getLimitLines = (dataPoints) => {
        let chartLineVal = 376.0; 
        if(dataPoints.length > 0) {
            const lastPt = dataPoints[dataPoints.length-1]; 
            const t = parseLiteral(lastPt.time);
            if (t) {
                const d = parseInt(t.day);
                const m = parseInt(t.month);
                if ((m === 11 && d >= 16) || (m === 12 && d <= 15)) { chartLineVal = 377.0; }
            }
        }
        return [
            { label: 'MNDBT (380.0)', data: new Array(dataPoints.length).fill(380.0), borderColor: 'rgba(239, 68, 68, 0.8)', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, fill: false },
            { label: `MN tr∆∞·ªõc l≈© (${chartLineVal})`, data: new Array(dataPoints.length).fill(chartLineVal), borderColor: 'rgba(245, 158, 11, 0.8)', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, fill: false },
            { label: 'MN ƒë√≥n l≈© min (370.0)', data: new Array(dataPoints.length).fill(370.0), borderColor: 'rgba(34, 211, 238, 0.8)', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, fill: false }
        ];
    };

    const getFlowLimitLines = (dataPoints) => {
        if(dataPoints.length === 0) return [];
        const lastPt = dataPoints[dataPoints.length-1];
        const t = parseLiteral(lastPt.time);
        if(t){
            const d = parseInt(t.day); const m = parseInt(t.month);
            const inSeason = (m===9 || m===10 || m===11) || (m===12 && d<=15);
            if(inSeason){
                return [
                    { label: 'Q duy tr√¨ (450)', data: new Array(dataPoints.length).fill(450), borderColor: 'rgba(59, 130, 246, 0.6)', borderWidth: 1, borderDash: [4, 4], pointRadius: 0, fill: false },
                    { label: 'Q c·∫Øt l≈© (600)', data: new Array(dataPoints.length).fill(600), borderColor: 'rgba(239, 68, 68, 0.6)', borderWidth: 1, borderDash: [4, 4], pointRadius: 0, fill: false }
                ];
            }
        }
        return [];
    };

    if (currentTab === 'WL_24H') {
      const data = state.latest24h; labels = data.map(r => formatChartLabel(r.time));
      datasets = [ { label:'M·ª±c n∆∞·ªõc (m)', data: data.map(r=>r.water_level), borderColor:rgba(C.WL,1), backgroundColor:rgba(C.WL,0.1), fill:true, borderWidth:2, pointRadius:0, tension:0.3 }, ...getLimitLines(data) ];
    }
    else if (currentTab === 'WL_7D') {
      const data = state.hourly7D_Obs; labels = data.map(r => formatChartLabel(r.time)); 
      datasets = [ { label:'M·ª±c n∆∞·ªõc (m)', data: data.map(r=>r.water_level), borderColor:rgba(C.WL,1), backgroundColor:rgba(C.WL,0.1), fill:true, borderWidth:2, pointRadius:0, tension:0.3 }, ...getLimitLines(data) ];
    }
    else if (currentTab === 'FLOW_24H') {
      const data = state.latest24h; labels = data.map(r => formatChartLabel(r.time));
      datasets = [ { label:'Q v·ªÅ', data: data.map(r=>r.inflow), borderColor:rgba(C.IN,1), borderWidth:1.5, pointRadius:0, tension:0.3, fill:false }, { label:'Q m√°y', data: data.map(r=>r.turbine_flow), borderColor:rgba(C.TB,1), borderWidth:1.5, pointRadius:0, tension:0.3, fill:false }, { label:'Q x·∫£', data: data.map(r=>r.spillway_flow), borderColor:rgba(C.SP,1), borderWidth:1.5, pointRadius:0, tension:0.3, fill:false }, ...getFlowLimitLines(data) ];
    }
    else if (currentTab === 'FLOW_7D') {
      const data = state.hourly7D_Obs; labels = data.map(r => formatChartLabel(r.time));
      datasets = [ { label:'Q v·ªÅ', data: data.map(r=>r.inflow), borderColor:rgba(C.IN,1), borderWidth:1.5, pointRadius:0, tension:0.3, fill:false }, { label:'Q m√°y', data: data.map(r=>r.turbine_flow), borderColor:rgba(C.TB,1), borderWidth:1.5, pointRadius:0, tension:0.3, fill:false }, { label:'Q x·∫£', data: data.map(r=>r.spillway_flow), borderColor:rgba(C.SP,1), borderWidth:1.5, pointRadius:0, tension:0.3, fill:false }, ...getFlowLimitLines(data) ];
    }
    else if (currentTab.startsWith('IN_OBS_FC_')) {
      const dStart = new Date($("day").value).setHours(0,0,0,0);
      const tMin = dStart - 3*86400000; const tMax = dStart + 4*86400000;
      
      const obsData = state.hourly3D.filter(r => { const t = new Date(r.time).getTime(); return t >= tMin && t < tMax; });
      
      let fcData = [];
      if (currentTab === 'IN_OBS_FC_V7') fcData = state.inflowFc_V7;
      else if (currentTab === 'IN_OBS_FC_MIX') fcData = state.inflowFc_Mix;
      else if (currentTab === 'IN_OBS_FC_AI') fcData = state.inflowFc_AI;
      
      fcData = fcData.filter(r => { const t = new Date(r.forecast_time).getTime(); return t >= tMin && t < tMax; });
      
      const allT = [...new Set([...obsData.map(r=>r.time), ...fcData.map(r=>r.forecast_time)])].sort();
      labels = allT.map(t => formatChartLabel(t));
      const dObs = allT.map(t => obsData.find(x => x.time === t)?.inflow ?? null);
      const dFc = allT.map(t => { const item = fcData.find(x => x.forecast_time === t); return item ? getFlowFc(item) : null; });
      
      const obsMap = new Map();
      state.hourly7D_Obs.forEach(x => obsMap.set(new Date(x.time).getTime(), x.inflow));
      const lastObsTime = state.lastObs ? new Date(state.lastObs.time).getTime() : 0;
      const dMA = allT.map(tStr => {
        const tCurrent = new Date(tStr).getTime(); if (tCurrent > lastObsTime) return null;
        let sum=0, cnt=0;
        for(let i=0; i<24; i++){ 
           const tPrev = tCurrent - i*3600000; 
           if(obsMap.has(tPrev)){ const val = obsMap.get(tPrev); if(val !== null && val !== undefined) { sum += val; cnt++; } }
        }
        return cnt > 0 ? sum/cnt : null;
      });

      datasets = [
        { label: 'Q Th·ª±c ƒëo', data: dObs, borderColor:rgba(C.IN,1), borderWidth:2, pointRadius:0, tension:0.3 },
        { label: 'MA 24h', data: dMA, borderColor:'#e879f9', borderWidth:1.5, pointRadius:0, tension:0.4, borderDash:[2,2], fill:false },
        { 
            label: 'Q D·ª± b√°o', 
            data: dFc, 
            borderColor: tabMeta[currentTab].color === C.IF ? '#FF9800' : `rgb(${tabMeta[currentTab].color})`, 
            borderDash:[4,4], borderWidth:2, pointRadius:0, tension:0.3 
        }
      ];
    }
    else if (currentTab === 'IN_FC_7D') {
      const tLimit = new Date($("day").value).setHours(0,0,0,0) + 7*86400000; 
      const times = Object.keys(state.fcEnsemble || {}).filter(t => { 
           const time = new Date(t).getTime(); return time >= new Date($("day").value).setHours(0,0,0,0) && time <= tLimit;
        }).sort();
      labels = times.map(t => formatChartLabel(t));
      const getVal = (t, src) => { 
          const group = state.fcEnsemble[t] || []; const found = group.find(i => i.source === src); 
          return found ? getFlowFc(found) : null; 
      };
      const d_high_raw = []; const d_low_raw = []; const d_mean = [];
      times.forEach(t => {
          let vMean = getVal(t, 'rf2q_v7'); if (vMean === null) vMean = 0;
          const realMax = vMean * 1.15; const realMin = vMean * 0.70;
          d_high_raw.push(realMax); d_low_raw.push(realMin); d_mean.push(vMean);
      });
      datasets = [
        { label: 'Bi√™n tr√™n', data: d_high_raw, borderColor: 'transparent', backgroundColor: rgba(C.WL, 0.15), pointRadius: 0, fill: '+1', tension: 0.4, order: 3 },
        { label: 'Bi√™n d∆∞·ªõi', data: d_low_raw, borderColor: 'transparent', backgroundColor: 'transparent', pointRadius: 0, fill: false, tension: 0.4, order: 2 },
        { label: 'D·ª± b√°o TB', data: d_mean, borderColor: '#FF9800', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: false, order: 1 }
      ];
    }
    else if (currentTab === 'RF_DAILY_FC') {
      const tLimit = new Date($("day").value).setHours(0,0,0,0) + 7*86400000;
      const filtered = state.rainFc.filter(r => { const t = new Date(r.forecast_time).getTime(); return t >= (new Date($("day").value).setHours(0,0,0,0)) && t < tLimit; });
      const agg = aggregateByDay(filtered, 'forecast_time');
      labels = Object.keys(agg).sort();
      const dailyData = labels.map(k => agg[k]);
      let sum = 0; const accData = dailyData.map(val => { sum += val; return sum; });
      datasets = [
        { type: 'bar', label: 'M∆∞a ng√†y (mm)', data: dailyData, backgroundColor: rgba(C.RN, 0.7), borderColor: rgba(C.RN, 1), borderWidth: 1, order: 2, yAxisID: 'y' },
        { type: 'line', label: 'L≈©y k·∫ø (mm)', data: accData, borderColor: rgba(C.ACC, 1), backgroundColor: rgba(C.ACC, 0.2), borderWidth: 2, pointRadius: 4, tension: 0.1, fill: false, order: 1, yAxisID: 'y1' }
      ];
      opts.scales.y1 = { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: rgba(C.ACC, 0.9) } };
    }
    else if (currentTab === 'RF_HOURLY_ACC') {
      const tLimit = new Date($("day").value).setHours(0,0,0,0) + 7*86400000;
      const filtered = state.rainFc.filter(r => { const t = new Date(r.forecast_time).getTime(); return t >= (new Date($("day").value).setHours(0,0,0,0)) && t <= tLimit; });
      labels = filtered.map(r => formatChartLabel(r.forecast_time));
      const hourlyData = filtered.map(r => getRain(r));
      let sum = 0; const accData = hourlyData.map(val => { sum += val; return sum; });
      datasets = [
        { type: 'bar', label: 'M∆∞a gi·ªù (mm)', data: hourlyData, backgroundColor: rgba(C.RN, 0.6), borderColor: rgba(C.RN, 1), borderWidth: 1, order: 2, yAxisID: 'y' },
        { type: 'line', label: 'L≈©y k·∫ø (mm)', data: accData, borderColor: rgba(C.ACC, 1), backgroundColor: rgba(C.ACC, 0.2), borderWidth: 2, pointRadius: 0, tension: 0.3, fill: false, order: 1, yAxisID: 'y1' }
      ];
      opts.scales.y1 = { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: rgba(C.ACC, 0.9) } };
    }
    else if (currentTab === 'RF_COMPARE') {
      const tEnd = new Date($("day").value).setHours(0,0,0,0) + 86400000 - 1; 
      const tStartCompare = tEnd - 7*86400000;
      
      const obs = state.hourly7D_Obs.filter(r => { const t=new Date(r.time).getTime(); return t>=tStartCompare && t<=tEnd; });
      const fc = state.rainFc.filter(r => { const t=new Date(r.forecast_time).getTime(); return t>=tStartCompare && t<=tEnd; });
      
      const aggObs = aggregateRainByDay(obs, 'time', 'rainfallreal');
      const aggFc = aggregateRainByDay(fc, 'forecast_time', 'rainfall_mm');
      
      const allDays = [...new Set([...Object.keys(aggObs), ...Object.keys(aggFc)])].sort();
      datasets = [
        { type: 'bar', label: 'Th·ª±c t·∫ø', data: allDays.map(k => aggObs[k]||0), backgroundColor: rgba(C.RF, 0.7) },
        { type: 'bar', label: 'D·ª± b√°o', data: allDays.map(k => aggFc[k]||0), backgroundColor: rgba(C.RN, 0.7) }
      ];
      labels = allDays;
    }

    const isMixed = (currentTab === 'RF_HOURLY_ACC' || currentTab === 'RF_DAILY_FC');
    const type = (currentTab.startsWith('RF_') && !isMixed) ? 'bar' : 'line';
    chart = new Chart(ctx, { type: (isMixed ? 'bar' : type), data:{labels, datasets}, options:opts });
  }

  function goTab(name, el){
    document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');

    if(name === 'data') loadTableData();
    if(name === 'forecast') loadForecasts(); 
    if(name === 'chart' && chart) chart.resize();
  }

  async function loadTableData() {
    const tb = $("tableBody");
    tb.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted);">ƒêang l·∫•y 24h s·ªë li·ªáu g·∫ßn nh·∫•t...</td></tr>`;
    try {
      const data = state.latest24h;
      if(data.length === 0) { tb.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`; return; }

      const tMax = data[data.length-1].time; const tMin = data[0].time; // Note: data is sorted ascending
      const resRain = await sb.from('rainfall_observed').select('*').gte('time', tMin).lte('time', tMax);
      const rainData = resRain.data || [];

      tb.innerHTML = "";
      
      // REVERSE the data for the table to show newest first
      const tableData = [...data].reverse();

      tableData.forEach(row => {
        const tRow = new Date(row.time).getTime();
        const rItem = rainData.find(x => Math.abs(new Date(x.time).getTime() - tRow) < 1800000);
        const rVal = getRain(rItem);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formatTableTime(row.time)}</td>
          <td style="color:rgb(var(--c-wl))">${fmt2.format(row.water_level)}</td>
          <td style="color:rgb(var(--c-in))">${fmt2.format(row.inflow)}</td>
          <td style="color:rgb(var(--c-tb))">${fmt2.format(row.turbine_flow)}</td>
          <td style="color:rgb(var(--c-sp))">${fmt2.format(row.spillway_flow)}</td>
          <td style="color:${rVal>0?'rgb(var(--c-green))':'#64748b'}">${rVal>0 ? fmt1.format(rVal) : '-'}</td>
        `;
        tb.appendChild(tr);
      });
    } catch(e) { console.error(e); }
  }

  async function loadForecasts() {
    const container = $("forecast-list");
    try {
      const { data, error } = await sb.from('bulletins').select('*').order('created_at', { ascending: false }).limit(10);
      if (error) throw error;
      if (!data || data.length === 0) {
        container.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted);">Ch∆∞a c√≥ b·∫£n tin n√†o.</div>`;
        return;
      }
      container.innerHTML = "";
      data.forEach((item, index) => {
        const title = item.title || "";
        const summary = item.summary || "";
        const text = (title + " " + summary).toLowerCase();
        
        let theme = { color: '#10b981', bg: 'rgba(16,185,129,0.15)', icon: 'üå§Ô∏è', label: 'D·ª± b√°o' };

        if (text.includes('l≈©') || text.includes('b√£o') || text.includes('kh·∫©n c·∫•p') || item.type === 'urgent') {
            theme = { color: '#ef4444', bg: 'rgba(239,68,68,0.15)', icon: '‚õàÔ∏è', label: 'Kh·∫©n c·∫•p' };
        } else if (text.includes('s·∫°t l·ªü') || text.includes('c·∫£nh b√°o') || item.type === 'warning') {
            theme = { color: '#f59e0b', bg: 'rgba(245,158,11,0.15)', icon: '‚ö†Ô∏è', label: 'C·∫£nh b√°o' };
        } else if (text.includes('v·∫≠n h√†nh') || text.includes('x·∫£') || text.includes('ƒëi·ªÅu ti·∫øt')) {
            theme = { color: '#3b82f6', bg: 'rgba(59,130,246,0.15)', icon: 'üíß', label: 'V·∫≠n h√†nh' };
        }

        const timeStr = formatToVNTime(item.created_at);
        const displaySummary = summary || (item.content ? item.content.substring(0, 80) + "..." : "Xem chi ti·∫øt");
        const content = item.content || "Kh√¥ng c√≥ n·ªôi dung";
        
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
            <div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('open')">
               <div class="icon-box" style="background:${theme.bg}; color:${theme.color};">${theme.icon}</div>
               <div class="item-content">
                  <h4 style="white-space: normal; color:${theme.color === '#10b981' ? 'var(--text-main)' : theme.color}">${title || 'B·∫£n tin d·ª± b√°o'}</h4>
                  <p>${displaySummary}</p>
                  <div style="display:flex; align-items:center; gap:6px; margin-top:4px;">
                    <span style="font-size:10px; font-weight:700; color:${theme.color}; border:1px solid ${theme.bg}; padding:2px 6px; border-radius:4px;">${theme.label}</span>
                    <span class="item-date">${timeStr}</span>
                  </div>
               </div>
            </div>
            <div class="accordion-body">${content}</div>
        `;
        container.appendChild(div);
      });
    } catch (e) { 
        console.error(e); 
        container.innerHTML = `<div style="padding:20px; text-align:center; color:#ef4444;">L·ªói t·∫£i d·ªØ li·ªáu: ${e.message}</div>`;
    }
  }
</script>
</body>
</html>
